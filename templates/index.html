<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Physics Topic RSS Aggregator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; background: #f9f9f9; }
    h1 { margin-bottom: 1rem; color: #222; }
    .debug { background: #e3f2fd; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #2196f3; font-family: monospace; font-size: 0.85rem; }
    .journal-section { margin-bottom: 3rem; background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .journal-title { font-size: 1.8rem; margin-bottom: 1.5rem; color: #333; border-bottom: 3px solid #0066cc; padding-bottom: 0.5rem; }
    .topic-subsection { margin-bottom: 2rem; padding-left: 1rem; border-left: 3px solid #e5e5e5; }
    .topic-subheading { font-size: 1.3rem; margin-bottom: 0.8rem; color: #0066cc; font-weight: 600; }
    .item { border-bottom: 1px solid #e5e5e5; padding: 1.2rem 0; }
    .item:last-child { border-bottom: none; }
    .item-title { font-size: 1.1rem; margin-bottom: 0.5rem; font-weight: 600; }
    .item-title a { color: #0066cc; text-decoration: none; }
    .item-title a:hover { text-decoration: underline; }
    .meta { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
    .source { color: #555; font-size: 0.85rem; margin-bottom: 0.5rem; font-style: italic; }
    .abstract { color: #444; font-size: 0.95rem; line-height: 1.6; margin-top: 0.8rem; padding: 0.8rem; background: #f5f5f5; border-radius: 4px; max-height: 200px; overflow-y: auto; }
    .count { color: #888; font-size: 0.9rem; margin-bottom: 1rem; }
    .loading { text-align: center; padding: 2rem; color: #666; }
    .special-section { background: #fff8e1; border-left: 4px solid #ffa726; }
    .special-section .journal-title { color: #f57c00; border-bottom-color: #ffa726; }
  </style>
</head>
<body>
  <h1>Physics Topic RSS Aggregator</h1>
  <div id="debug" class="debug">Initializing...</div>
  <div id="content" class="loading">Loading feeds...</div>
  <script>
    // Topics must match the keys in feeds.yaml (using hyphens, lowercase)
    const TOPICS = ['ion-trap', 'trapped-ion', 'quantum-networks', 'cavity-qed', 'quantum-networks-ion', 'quantum-networks-neutral'];
    const TOPIC_DISPLAY = {
      'ion-trap': 'Ion Trap',
      'trapped-ion': 'Trapped Ion',
      'quantum-networks': 'Quantum Networks',
      'cavity-qed': 'Cavity QED',
      'quantum-networks-ion': 'Quantum Networks & Ion',
      'quantum-networks-neutral': 'Quantum Networks & Neutral'
    };
    const JOURNALS = ['Nature', 'Nature Physics', 'Science', 'PRL', 'PRA', 'PRX', 'PRX Quantum', 'Physical Review Letters', 'Physical Review A', 'arXiv', 'Other'];
    
    // Calculate date 2 months ago (per backend filter)
    function getTwoMonthsAgo() {
      const date = new Date();
      date.setMonth(date.getMonth() - 2);
      return date;
    }
    
    // Check if item is within last 2 months
    function isRecent(dateStr) {
      if (!dateStr) return true; // Include if no date
      const itemDate = new Date(dateStr);
      return itemDate >= getTwoMonthsAgo();
    }
    
    // Extract journal name from source
    function getJournal(source) {
      if (!source) return 'Other';
      const s = source.toLowerCase();
      if (s.includes('nature physics')) return 'Nature Physics';
      if (s.includes('nature')) return 'Nature';
      if (s.includes('science')) return 'Science';
      if (s.includes('prx quantum')) return 'PRX Quantum';
      if (s.includes('prx')) return 'PRX';
      if (s.includes('physical review letters') || s.includes('prl')) return 'PRL';
      if (s.includes('physical review a') || s.includes('pra')) return 'PRA';
      if (s.includes('arxiv')) return 'arXiv';
      return 'Other';
    }
    
    // Fetch all topics
    async function loadAllTopics() {
      const contentEl = document.getElementById('content');
      const debugEl = document.getElementById('debug');
      contentEl.innerHTML = '<div class="loading">Loading feeds...</div>';
      debugEl.innerHTML = 'Starting to fetch topics...<br>';
      
      const allData = {};
      const debugInfo = [];
      
      // Fetch data for each topic
      for (const topic of TOPICS) {
        try {
          const topicDisplay = topic.replace(/-/g, ' ');
          debugEl.innerHTML += `Fetching topic: ${topicDisplay}...<br>`;
          const response = await fetch(`/rss/${encodeURIComponent(topic)}`);
          if (!response.ok) {
            debugEl.innerHTML += `  ❌ Error ${response.status} for ${topicDisplay}<br>`;
            continue;
          }
          const data = await response.json();
          debugEl.innerHTML += `  ✓ Got ${data.count || 0} items for ${topicDisplay}<br>`;
          debugInfo.push(`${topicDisplay}: ${data.count || 0} items`);
          
          // Filter recent items and organize by journal
          if (data.items && data.items.length > 0) {
            data.items.forEach(item => {
              if (isRecent(item.published || item.pubDate)) {
                const journal = getJournal(item.source);
                
                if (!allData[journal]) {
                  allData[journal] = {};
                }
                if (!allData[journal][topic]) {
                  allData[journal][topic] = [];
                }
                allData[journal][topic].push(item);
              }
            });
          }
        } catch (error) {
          const topicDisplay = topic.replace(/-/g, ' ');
          debugEl.innerHTML += `  ❌ Exception for ${topicDisplay}: ${error.message}<br>`;
          console.error(`Error loading topic ${topic}:`, error);
        }
      }
      
      // Clear loading message
      contentEl.innerHTML = '';
      debugEl.innerHTML += '<br><strong>Summary:</strong><br>' + debugInfo.join('<br>');
      
      // Render by journal, then by topic
      let totalItems = 0;
      for (const journal of JOURNALS) {
        if (!allData[journal]) continue;
        
        const journalSection = document.createElement('div');
        journalSection.className = 'journal-section';
        if (journal === 'arXiv') {
          journalSection.classList.add('special-section');
        }
        
        const journalTitle = document.createElement('h2');
        journalTitle.className = 'journal-title';
        journalTitle.textContent = journal;
        journalSection.appendChild(journalTitle);
        
        for (const topic of TOPICS) {
          if (!allData[journal][topic] || allData[journal][topic].length === 0) continue;
          
          const topicSubsection = document.createElement('div');
          topicSubsection.className = 'topic-subsection';
          
          const topicSubheading = document.createElement('h3');
          topicSubheading.className = 'topic-subheading';
          topicSubheading.textContent = TOPIC_DISPLAY[topic] || topic.replace(/-/g, ' ');
          topicSubsection.appendChild(topicSubheading);
          
          const countDiv = document.createElement('div');
          countDiv.className = 'count';
          countDiv.textContent = `${allData[journal][topic].length} items`;
          topicSubsection.appendChild(countDiv);
          
          totalItems += allData[journal][topic].length;
          
          allData[journal][topic].forEach(item => {
            topicSubsection.appendChild(createItemElement(item, topic));
          });
          
          journalSection.appendChild(topicSubsection);
        }
        
        contentEl.appendChild(journalSection);
      }
      
      debugEl.innerHTML += `<br><strong>Total items displayed: ${totalItems}</strong>`;
      
      if (contentEl.children.length === 0) {
        contentEl.innerHTML = '<div class="loading">No items found in the last 2 months.</div>';
      }
    }
    
    function createItemElement(item, topic) {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'item';
      
      // Title
      const titleDiv = document.createElement('div');
      titleDiv.className = 'item-title';
      if (item.link) {
        const link = document.createElement('a');
        link.href = item.link;
        link.target = '_blank';
        link.textContent = item.title || 'Untitled';
        titleDiv.appendChild(link);
      } else {
        titleDiv.textContent = item.title || 'Untitled';
      }
      itemDiv.appendChild(titleDiv);
      
      // Metadata
      const metaDiv = document.createElement('div');
      metaDiv.className = 'meta';
      const pubDate = item.published || item.pubDate || 'Date unknown';
      metaDiv.textContent = `Published: ${pubDate}`;
      itemDiv.appendChild(metaDiv);
      
      // Source
      if (item.source) {
        const sourceDiv = document.createElement('div');
        sourceDiv.className = 'source';
        sourceDiv.textContent = `Source: ${item.source}`;
        itemDiv.appendChild(sourceDiv);
      }
      
      // Abstract/Summary
      if (item.summary || item.description || item.abstract) {
        const abstractDiv = document.createElement('div');
        abstractDiv.className = 'abstract';
        const abstractText = item.abstract || item.summary || item.description;
        // Remove HTML tags if present
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = abstractText;
        abstractDiv.textContent = tempDiv.textContent || tempDiv.innerText || abstractText;
        itemDiv.appendChild(abstractDiv);
      }
      
      return itemDiv;
    }
    
    // Load on page load
    window.addEventListener('DOMContentLoaded', loadAllTopics);
  </script>
</body>
</html>
